<!DOCTYPE html>
<html>
<head>
    <!-- TODO: http://jsfiddle.net/heera/tBmcE/2/ -->
    <meta charset="utf-8">
    <title>Goblock</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="assets/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/alertifyjs/css/alertify.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/alertifyjs/css/themes/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/goblock.css" />
</head>
<body>

    <div class="row container col-md-12">

        <!-- Header -->
        <div id="__header" class="col-md-12">
            <nav>
                <ul id="__menuContainer" class="nav nav-pills pull-right">
                    <li class="active" role="presentation"><a id="__homeMenu" class="__menu" href="#"><i class="glyphicon glyphicon-home"></i> Home</a></li>
                    <li role="presentation"><a id="__lessonMenu" class="__menu" href="#"><i class="glyphicon glyphicon-book"></i> Lessons</a></li>
                    <li role="presentation"><a id="__aboutMenu" class="__menu" href="#"><i class="glyphicon glyphicon-user"></i> About</a></li>
                </ul>
            </nav>
            <h3 class="text-muted">Goblock | Visual Programming For Newbie</h3>
        </div>
        <!-- End of Header -->

        <!-- Main Container -->
        <div id="__mainContainer" class="col-md-12">
            <div class="col-md-7">
                <div id="__blockContainer">
                    <legend>Block</legend>
                    <div class="__btnDiv">
                        <button id="__runCode" class="btn btn-primary">
                            <i class="glyphicon glyphicon-play"></i> Run
                        </button>
                        <button id="__switchToXml" class="btn btn-default">
                            <i class="glyphicon glyphicon-align-justify"></i> XML
                        </button>
                        <button class="__clearCode btn btn-danger">
                            <i class="glyphicon glyphicon-trash"></i> Clear
                        </button>
                    </div>
                    <div id="__blocklyDiv"></div>
                </div>

                <div id="__xmlContainer">
                    <legend>Xml</legend>
                    <div class="__btnDiv">
                        <button id="__synchronize" class="btn btn-primary">
                            <i class="glyphicon glyphicon-retweet"></i> Synchronize
                        </button>
                        <button id="__switchToBlock" class="btn btn-default">
                            <i class="glyphicon glyphicon-tasks"></i> Block
                        </button>
                        <button class="__clearCode btn btn-danger">
                            <i class="glyphicon glyphicon-trash"></i> Clear
                        </button>
                    </div>
                    <textarea id="__xml"></textarea> 
                </div>

                

            </div>
            <div id="__rightPane" class="col-md-5">  
                <legend>Program Output</legend>
                <div id="__output" class="well col-md-"></div>

                <legend>Python Code</legend>
                <pre id="__pythonCode"></pre>

                <legend>Javascript Code</legend>
                <pre id="__jsCode"></pre>
            </div>

        </div>
        <!-- End of Main Container -->

        <!-- Lesson Container -->
        <div id="__lessonContainer" class="col-md-12">
            <div class="alert alert-warning"><b>Under Construction</b> Will be here soon</div>
        </div>
        <!-- End of Lesson Container -->

        <!-- About Container -->
        <div id="__aboutContainer" class="col-md-12"></div>
        <!-- End of About Container -->

    </div>

    <footer class="row container col-md-12">
        <p id="__footer" class="pull-right">
            Go Frendi Gunawan (gofrendiasgard@gmail.com) &copy; 2014
        </p>
    </footer>
    
    <!-- Toolbox __xml -->
    <xml id="__toolbox" style="display: none">
        <category name="Values">
            <block type="text"></block>
            <block type="logic_boolean"></block>
            <block type="math_number"></block>
            <block type="math_constant"></block>
            <block type="lists_create_empty"></block>
            <block type="lists_create_with"></block>
            <block type="lists_repeat">
                <value name="NUM">
                    <block type="math_number">
                        <field name="NUM">5</field>
                    </block>
                </value>
            </block>
        </category>
        <category name="Variables" custom="VARIABLE"></category>
        <category name="Input/Output">            
            <block type="text_print"></block>
            <block type="text_prompt"></block>
        </category>
        <category name="Operations">
            <category name="Text">
                <block type="text_length"></block>
                <block type="text_join"></block>
            </category>
            <category name="Math">
                <block type="math_arithmetic"></block>
                <block type="math_single"></block>
                <block type="math_trig"></block>
                <block type="math_number_property"></block>
                <block type="math_change">
                    <value name="DELTA">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                </block>
                <block type="math_round"></block>
                <block type="math_on_list"></block>
                <block type="math_modulo"></block>
                <block type="math_constrain">
                    <value name="LOW">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                    <value name="HIGH">
                        <block type="math_number">
                            <field name="NUM">100</field>
                        </block>
                    </value>
                </block>
                <block type="math_random_int">
                    <value name="FROM">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                    <value name="TO">
                        <block type="math_number">
                            <field name="NUM">100</field>
                        </block>
                    </value>
                </block>
                <block type="math_random_float"></block>
            </category>
            <category name="Boolean">
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
            <category name="Lists (Array)">
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf"></block>
                <block type="lists_getIndex"></block>
                <block type="lists_setIndex"></block>
            </category>
        </category>
        <category name="Controls">
            <category name="If (Branch)">
                <block type="controls_if"></block>
                <block type="controls_if">
                    <mutation else="1"></mutation>
                </block>
                <block type="controls_if">
                    <mutation elseif="1" else="1"></mutation>
                </block>
            </category>
            <category name="Loops (Iteration)">
                <block type="controls_repeat_ext">
                    <value name="TIMES">
                        <block type="math_number">
                            <field name="NUM">10</field>
                        </block>
                    </value>
                </block>
                <block type="controls_whileUntil"></block>
                <block type="controls_for">
                    <field name="VAR">i</field>
                    <value name="FROM">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                    <value name="TO">
                        <block type="math_number">
                            <field name="NUM">10</field>
                        </block>
                    </value>
                    <value name="BY">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                </block>
                <block type="controls_forEach"></block>
                <block type="controls_flow_statements"></block>
            </category>
        </category>
        <category name="Functions" custom="PROCEDURE"></category>
    </xml>

    <!-- initialScript XML -->
    <xml id="__startBlocks" __xmlns="http://www.w3.org/1999/xhtml">
        <block type="text_print" id="1" inline="false" x="10" y="10">
            <value name="TEXT">
                <block type="text" id="2">
                    <field name="TEXT">Hi, my name is Guo, a programming panda</field>
                </block>
            </value>
            <next>
                <block type="text_print" id="21" inline="false">
                    <value name="TEXT">
                        <block type="text" id="26">
                            <field name="TEXT">Nice to meet you :)</field>
                        </block>
                    </value>
                </block>
            </next>
        </block>
    </xml>



    <script type="text/javascript" src="assets/jquery/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="assets/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="assets/blockly/blocks_compressed.js"></script>
    <script type="text/javascript" src="assets/blockly/javascript_compressed.js"></script>
    <script type="text/javascript" src="assets/blockly/python_compressed.js"></script>
    <script type="text/javascript" src="assets/blockly/msg/js/en.js"></script>
    <script type="text/javascript" src="assets/alertifyjs/alertify.min.js"></script>
    <script type="text/javascript" src="assets/stratifiedjs/stratified.js"></script>
    <script type="text/javascript" src="assets/goblock.js"></script>

    <script id="__asyncFunc" type="text/sjs">
        // STATE VARIABLE
        var __promptClicked = true;

        function __outputAlert(message) {
            __waitPrompt();
            message = __stripHtml(message);
            $('#__output').append('<b>' + message + '</b><br />');
        }
        
        function __waitPrompt(){
            while(!__promptClicked){
                hold(500);
            }
        }

        function __outputPrompt(message){
            __waitPrompt();
            __promptClicked = false
            var input = '';
            alertify.prompt(
                'Input',
                message,
                '',
                function(evt,val){input = val; __promptClicked = true},
                function(evt,val){input = val; __promptClicked = true}
            ).set('closable',false);

            __waitPrompt();

            message = __stripHtml(message);
            $('#__output').append((message == '' ? '' : '<b>' + message + '</b><br />') + 
                __stripHtml(input) + '<br />');
            return input;
        }
    </script>

    <script type="text/sjs">    
            
        var __sys = require("assets/stratifiedjs/modules/sys.sjs");    

        // initialize blockly
        Blockly.inject(document.getElementById('__blocklyDiv'),
        {
            toolbox: document.getElementById('__toolbox'),
            media: './assets/blockly/media/',
        });

        // load initial blocks
        __xml = document.getElementById('__startBlocks');
        __loadXml(__xml);

        // on change
        Blockly.addChangeListener(function() {
            // Generate JavaScript code and display it.
            Blockly.Python.INFINITE_LOOP_TRAP = null;
            var code = Blockly.Python.workspaceToCode();
            $('#__pythonCode').html(__stripHtml(code));
            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
            var code = Blockly.JavaScript.workspaceToCode();
            $('#__jsCode').html(__stripHtml(code));

            var __xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
            $('#__xml').html(Blockly.Xml.domToPrettyText(__xml));
        });

        // EVENTS

        $('#__runCode').click(__runCode);
        
        $('#__synchronize').click(function(){
            __showBlockContainer();
            var __xml = Blockly.Xml.textToDom($('#__xml').val());
            __loadXml(__xml);
        });

        

        // FUNCTIONS

        function __loadXml(__xml){
            __clearCode();
            Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,__xml);
            __runCode();
        }

        function __runCode() {
            $('#__output').html('');
            // Generate JavaScript code and run it.
            window.LoopTrap = 1000;
            Blockly.JavaScript.INFINITE_LOOP_TRAP =
                    'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';

            // prefix code
            var prefix = $('#__asyncFunc').html();

            // code
            var code = Blockly.JavaScript.workspaceToCode();
            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
            try {
                // do replacement
                code = code.split("window.alert(").join("__outputAlert(");
                code = code.split("window.prompt(").join("__outputPrompt(");
                code = code.split(";").join(";__waitPrompt();");
                console.log(prefix+code);
                __sys.eval(prefix + code);
            } catch (e) {
                __outputAlert(e);
            }
        }

    </script>

</body>
</html>
